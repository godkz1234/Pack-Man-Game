#include "game.h"
#include <stdio.h>
#include <conio.h>
#include <stdlib.h>
#include <time.h>

// 새로운 함수: 시작 화면 출력
void ShowStartScreen(HANDLE hConsole) {
    system("cls");  // 화면을 지우기
    SetConsoleActiveScreenBuffer(hConsole);  // 현재 활성화된 버퍼로 설정

    printf("\n\n\n\n\n\n\n\n\n");
    printf("                                      Pac-Man                                      \n");
    printf("                                                                                   \n");
    printf("                             맵안에 있는 모든 아이템을                             \n");
    printf("                                전부 먹으시면 승리!                                \n");
    printf("                             고스트에게 붙잡히면 패배!                             \n");
    printf("                             고스트에게서 도망치세요!                              \n");
    printf("                                                                                   \n");
    printf("                                     -Controls-                                    \n");
    printf("                                       방향키                                      \n");
    printf("                                                                                   \n");
    printf("                             -Press any key to start-                              \n");

    (void)_getch();  // 사용자가 아무 키나 누르면 계속 진행
}

// 미로 배열 선언 (게임 전반에 사용할 전역 변수)
extern char maze[HEIGHT][WIDTH] = {
{ '2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2' },
{ '2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2','2' },
{ '2','2','2','2','2','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','1','0','1','1','0','1','0','1','1','0','1','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','1','0','1','1','0','1','0','1','1','0','1','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','1','0','1','1','0','1','0','1','1','0','1','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','1','0','1','1','0','1','0','1','1','0','1','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','0','1','1','1','1','1','1','1','1','1','1','1','0','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','0','1','1','1','1','1','1','1','1','1','1','1','0','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','1','1','0','0','0','0','1','1','1','1','1','0','0','0','0','1','1','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','1' },
{ '2','2','2','2','2','1','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','0','1','1','1','1','1','1' },
{ '2','2','2','2','2','1','1','1','1','1','1','0','1','1','0','0','0','0','1','1','1','1','1','0','0','0','0','1','1','0','1','1','1','1','1','1' },
{ '2','2','2','2','2','1','1','1','1','1','1','0','1','1','0','1','1','0','0','0','0','0','0','0','1','1','0','1','1','0','1','1','1','1','1','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','0','0','0','0','0','1','1','1','1','1','0','0','0','0','0','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','0','1','0','0','0','0','0','0','0','1','0','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','1','0','1','1','1','0','1','1','1','1','1','1','1','1','1','0','1','1','1','0','1','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','1','0','1','1','1','0','0','0','0','0','0','0','0','0','0','0','1','1','1','0','1','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','0','1','1','1','1','1','1','1','1','1','0','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','0','0','0','1','0','0','0','1','0','0','0','1','0','0','0','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','0','1','1','1','0','0','0','0','0','1','0','0','0','0','0','1','1','1','0','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','1','0','0','0','0','0','0','0','0','0','1','0','0','0','0','0','0','0','0','0','1','0','0','0','0','1' },
{ '2','2','2','2','2','1','1','1','1','0','1','0','0','1','1','0','1','0','0','0','1','0','0','0','1','0','1','1','0','0','1','0','1','1','1','1' },
{ '2','2','2','2','2','1','1','1','1','0','1','0','0','1','1','0','1','1','1','1','1','1','1','1','1','0','1','1','0','0','1','0','1','1','1','1' },
{ '2','2','2','2','2','1','1','1','1','0','1','0','0','1','1','0','0','0','0','0','0','0','0','0','0','0','1','1','0','0','1','0','1','1','1','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','1','1','0','1','1','1','1','1','1','1','1','1','0','1','1','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','1','1','1','1','0','1','0','0','0','1','0','0','0','1','0','1','1','1','1','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','1','1','1','1','1','1','1','1','0','1','0','0','0','1','0','0','0','1','0','1','1','1','1','1','1','1','1','0','1' },
{ '2','2','2','2','2','1','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','0','1' },
{ '2','2','2','2','2','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1','1' }
};

// 콘솔 커서 위치를 설정하는 함수
void Position(HANDLE hConsole, int x, int y) {
    COORD position = { x * 2, y };  // x를 2배로 하여 공백 고려
    SetConsoleCursorPosition(hConsole, position);
}

// 게임 화면을 그리는 함수
void Render(HANDLE hConsole, Character player, Character ghosts[], int ghostCount, Item items[], int score, HANDLE hOutputBuffer) {
    for (int i = 0; i < HEIGHT; i++) {
        for (int j = 0; j < WIDTH; j++) {
            if (maze[i][j] == '0') {
                Position(hOutputBuffer, j, i);
                printf("  ");
            }
            else if (maze[i][j] == '1') {
                Position(hOutputBuffer, j, i);
                printf("■");
            }
            else if (maze[i][j] == '2') {
                Position(hOutputBuffer, j, i);
                printf(" ");
            }
        }
    }

    // 플레이어 위치 그리기
    Position(hOutputBuffer, player.x, player.y);
    printf("%s", player.shape);

    // 고스트 그리기
    for (int i = 0; i < ghostCount; i++) {
        Position(hOutputBuffer, ghosts[i].x, ghosts[i].y);
        printf("%s", ghosts[i].shape);
    }

    // 활성화된 아이템 그리기
    for (int i = 0; i < ITEM_COUNT; i++) {
        if (items[i].active) {
            Position(hOutputBuffer, items[i].x, items[i].y);
            printf("★");
        }
    }

    // 점수 표시
    Position(hOutputBuffer, 0, HEIGHT + 1);
    printf("Score: %d\n", score);
}

// 고스트 이동 함수
void MoveGhost(Character* ghost, Character player, int* moveCounter) {
    (*moveCounter)++;
    if (*moveCounter % 3 != 0) {
        return;  // 고스트 이동 속도 제어
    }

    if (ghost->x < player.x && maze[ghost->y][ghost->x + 1] != '1') {
        ghost->x++;
    }
    else if (ghost->x > player.x && maze[ghost->y][ghost->x - 1] != '1') {
        ghost->x--;
    }

    if (ghost->y < player.y && maze[ghost->y + 1][ghost->x] != '1') {
        ghost->y++;
    }
    else if (ghost->y > player.y && maze[ghost->y - 1][ghost->x] != '1') {
        ghost->y--;
    }
}

// 아이템 생성 함수
void GenerateItems(Item items[]) {
    srand(time(NULL));  // 랜덤 시드 설정

    int generated = 0;
    while (generated < ITEM_COUNT) {
        int x = rand() % WIDTH;
        int y = rand() % HEIGHT;

        if (maze[y][x] == '0') {  // 빈 공간에만 아이템을 생성
            items[generated].x = x;
            items[generated].y = y;
            items[generated].active = 1;
            generated++;
        }
    }
}

// 아이템 수집 체크 함수
int CheckItemCollection(Character* player, Item items[]) {
    for (int i = 0; i < ITEM_COUNT; i++) {
        if (items[i].active && player->x == items[i].x && player->y == items[i].y) {
            items[i].active = 0;
            return 1;  // 점수 1점 추가
        }
    }
    return 0;
}

// 모든 아이템 수집 여부 체크
int AllItemsCollected(Item items[]) {
    for (int i = 0; i < ITEM_COUNT; i++) {
        if (items[i].active) {
            return 0;
        }
    }
    return 1;
}

// 게임 오버 처리
void GameOver(HANDLE hConsole) {
    Position(hConsole, 0, HEIGHT + 2);
    printf("Game Over! You were caught by the ghosts!\n");
}

// 게임 승리 처리
void Victory(HANDLE hConsole) {
    Position(hConsole, 0, HEIGHT + 2);
    printf("Victory! You've collected all the items!\n");
}

// 게임 종료 후 다시 시작 여부 묻기
int AskRestart(HANDLE hConsole) {
    Position(hConsole, 0, HEIGHT + 3);
    printf("Press 'r' to restart or any other key to exit.\n");
    char key = _getch();
    if (key == 'r' || key == 'R') {
        return 1;
    }
    return 0;
}

// 더블 버퍼링 초기화 함수
void InitializeDoubleBuffer(HANDLE* hOutputBuffer, HANDLE* hOriginalBuffer) {
    *hOriginalBuffer = GetStdHandle(STD_OUTPUT_HANDLE);  // 원래 콘솔 버퍼 저장

    CONSOLE_SCREEN_BUFFER_INFO csbi;
    GetConsoleScreenBufferInfo(*hOriginalBuffer, &csbi);  // 원래 콘솔 버퍼 정보 가져오기

    *hOutputBuffer = CreateConsoleScreenBuffer(
        GENERIC_WRITE, FILE_SHARE_WRITE, NULL, CONSOLE_TEXTMODE_BUFFER, NULL);  // 새로운 버퍼 생성

    SetConsoleActiveScreenBuffer(*hOutputBuffer);  // 새로운 버퍼 활성화
}

// 버퍼 스위칭 함수
void SwitchBuffer(HANDLE* hOutputBuffer, HANDLE* hOriginalBuffer) {
    SetConsoleActiveScreenBuffer(*hOutputBuffer);
    HANDLE temp = *hOutputBuffer;
    *hOutputBuffer = *hOriginalBuffer;
    *hOriginalBuffer = temp;
}
